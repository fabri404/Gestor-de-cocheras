{# users/templates/users/dashboard.html #}
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container py-4">

  {# ========= Header / Toolbar ========= #}
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3 p-md-4">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
          <h2 class="mb-1">Dashboard</h2>
          <div class="text-muted">
            Resumen de tus cocheras, ocupaci√≥n y √∫ltimos movimientos.
          </div>
        </div>

        <div class="d-flex flex-column flex-sm-row gap-2">
          <form class="d-flex" method="get" action="">
            <div class="input-group">
              <span class="input-group-text">üîé</span>
              <input
                type="search"
                name="q"
                class="form-control"
                placeholder="Buscar cochera..."
                value="{{ request.GET.q|default:'' }}"
                aria-label="Buscar cochera"
              >
              <button class="btn btn-outline-secondary" type="submit">Buscar</button>
            </div>
          </form>

          {% if can_manage_cochera %}
            <a class="btn btn-primary" href="{% url 'cochera_new' %}">
              <span class="me-1">Ôºã</span> Crear cochera
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# ========= M√©tricas globales ========= #}
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">M√©tricas globales</h4>
    <div class="text-muted small">
      Ocupaci√≥n global: <span class="fw-semibold">{{ ocupacion_pct|default:0 }}%</span>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small mb-1">Total espacios</div>
          <div class="display-6 mb-0">{{ total_espacios|default:0 }}</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small mb-1">Ocupados</div>
          <div class="display-6 mb-0">{{ ocupados|default:0 }}</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small mb-1">Libres</div>
          <div class="display-6 mb-0">{{ libres|default:0 }}</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted small mb-1">Mov. abiertos</div>
          <div class="display-6 mb-0">{{ mov_abiertos|default:0 }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-semibold">Ocupaci√≥n (todas las cocheras)</div>
        <div class="text-muted small">{{ ocupacion_pct|default:0 }}%</div>
      </div>
      <div class="progress" style="height: 10px;">
        <div
          class="progress-bar"
          role="progressbar"
          style="width: {{ ocupacion_pct|default:0 }}%;"
          aria-valuenow="{{ ocupacion_pct|default:0 }}"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>

      <div class="mt-2 text-muted small">
        {% if total_facturado is None %}
          Monto total: (pendiente de implementar facturaci√≥n/tarifas)
        {% else %}
          Monto total: <span class="fw-semibold">{{ total_facturado }}</span>
        {% endif %}
      </div>
    </div>
  </div>

  {# ========= Mis cocheras ========= #}
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Mis cocheras</h4>
    <div class="text-muted small">
      {% if cocheras_data %}{{ cocheras_data|length }} en total{% endif %}
    </div>
  </div>

  {% if cocheras_data %}
    <div class="row g-3">
      {% for item in cocheras_data %}
        {% with c=item.cochera %}
        {% widthratio item.ocupados item.total_espacios 100 as occ_pct %}
        <div class="col-12 col-xl-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">

              {# Header del card #}
              <div class="d-flex align-items-start justify-content-between gap-3">
                <div class="me-2">
                  <div class="d-flex flex-wrap align-items-center gap-2">
                    <h5 class="mb-0">{{ c.nombre }}</h5>

                    <span class="badge rounded-pill text-bg-{% if c.activa %}success{% else %}secondary{% endif %}">
                      {% if c.activa %}Activa{% else %}Inactiva{% endif %}
                    </span>

                    <span class="badge rounded-pill text-bg-{% if item.is_owner %}primary{% else %}info{% endif %}">
                      {% if item.is_owner %}Due√±o{% else %}Empleado{% endif %}
                    </span>
                  </div>

                  <div class="text-muted small mt-1">
                    üìç {{ c.direccion|default:"(sin direcci√≥n)" }}
                  </div>
                </div>

                <div class="text-end">
                  <div class="text-muted small">Ocupaci√≥n</div>
                  <div class="fs-4 fw-semibold">{{ item.ocupados }}/{{ item.total_espacios }}</div>
                  <div class="text-muted small">Libres: {{ item.libres }}</div>
                </div>
              </div>

              {# Progress ocupaci√≥n #}
              <div class="mt-3">
                <div class="d-flex align-items-center justify-content-between small text-muted mb-1">
                  <span>Ocupaci√≥n</span>
                  <span>{{ occ_pct }}%</span>
                </div>
                <div class="progress" style="height: 10px;">
                  <div
                    class="progress-bar {% if occ_pct >= 90 %}bg-danger{% elif occ_pct >= 70 %}bg-warning{% else %}bg-success{% endif %}"
                    role="progressbar"
                    style="width: {{ occ_pct }}%;"
                    aria-valuenow="{{ occ_pct }}"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>

              {# Stats r√°pidas #}
              <div class="row g-2 mt-3">
                <div class="col-6 col-md-3">
                  <div class="border rounded-3 p-2">
                    <div class="text-muted small">Total</div>
                    <div class="fw-semibold">{{ item.total_espacios }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="border rounded-3 p-2">
                    <div class="text-muted small">Ocupados</div>
                    <div class="fw-semibold">{{ item.ocupados }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="border rounded-3 p-2">
                    <div class="text-muted small">Libres</div>
                    <div class="fw-semibold">{{ item.libres }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="border rounded-3 p-2">
                    <div class="text-muted small">Mov. abiertos</div>
                    <div class="fw-semibold">{{ item.mov_abiertos }}</div>
                  </div>
                </div>
              </div>

              {# Detalle por tipo colapsable #}
              <div class="mt-3">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#porTipo{{ c.id }}"
                  aria-expanded="false"
                  aria-controls="porTipo{{ c.id }}"
                >
                  Ver detalle por tipo
                </button>

                <div class="collapse mt-2" id="porTipo{{ c.id }}">
                  <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Tipo</th>
                          <th class="text-end">Total</th>
                          <th class="text-end">Ocupados</th>
                          <th class="text-end">Libres</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in item.por_tipo %}
                          <tr>
                            <td class="fw-semibold">{{ row.tipo.nombre }}</td>
                            <td class="text-end">{{ row.total }}</td>
                            <td class="text-end">{{ row.ocupados }}</td>
                            <td class="text-end">{{ row.libres }}</td>
                          </tr>
                        {% empty %}
                          <tr><td colspan="4" class="text-muted">Sin capacidades configuradas.</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>

            {# Footer con acciones #}
            <div class="card-footer bg-transparent border-0 pt-0 pb-3 px-3">
              <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                <div class="btn-group" role="group" aria-label="Acciones cochera">
                  <a class="btn btn-outline-primary btn-sm" href="{% url 'parking:cochera_detail' c.id %}">
                    Detalle
                  </a>

                  {% if can_manage_cochera and item.is_owner %}
                    <a class="btn btn-outline-warning btn-sm" href="{% url 'parking:cochera_edit' c.id %}">
                      Editar
                    </a>
                  {% endif %}

                  <a class="btn btn-outline-secondary btn-sm" href="{% url 'parking:cochera_qr' c.id %}" target="_blank">
                    QR
                  </a>
                </div>

                {% if can_operate %}
                  <div class="btn-group" role="group" aria-label="Operaci√≥n">
                    <a class="btn btn-success btn-sm" href="{% url 'parking:ingreso_cochera' c.id %}">
                      Ingreso
                    </a>
                    <a class="btn btn-danger btn-sm" href="{% url 'parking:egreso_cochera' c.id %}">
                      Egreso
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>

  {% else %}
    <div class="card shadow-sm">
      <div class="card-body p-4 text-center">
        <div class="fs-1 mb-2">üÖøÔ∏è</div>
        <h5 class="mb-1">Todav√≠a no ten√©s cocheras asignadas</h5>
        <div class="text-muted mb-3">
          {% if can_manage_cochera %}
            Cre√° tu primera cochera para empezar a registrar ingresos y egresos.
          {% else %}
            Pedile al due√±o que te asigne a una cochera para poder operar.
          {% endif %}
        </div>

        {% if can_manage_cochera %}
          <a class="btn btn-primary" href="{% url 'cochera_new' %}">Crear cochera</a>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {# ========= Global por tipo ========= #}
  <hr class="my-4">

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Detalle global por tipo</h4>
    <div class="text-muted small">Capacidades agregadas</div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Tipo</th>
              <th class="text-end">Total</th>
              <th class="text-end">Ocupados</th>
              <th class="text-end">Libres</th>
            </tr>
          </thead>
          <tbody>
            {% for row in totales_por_tipo %}
              <tr>
                <td class="fw-semibold">{{ row.tipo.nombre }}</td>
                <td class="text-end">{{ row.total }}</td>
                <td class="text-end">{{ row.ocupados }}</td>
                <td class="text-end">{{ row.libres }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No hay datos de capacidades.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# ========= √öltimos movimientos ========= #}
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">√öltimos movimientos</h4>
    <div class="text-muted small">Actividad reciente</div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr>
              <th class="text-nowrap">Fecha</th>
              <th>Cochera</th>
              <th>Ticket</th>
              <th>Tipo</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for m in ultimos %}
              <tr>
                <td class="text-nowrap">
                  {{ m.ingreso_at|date:"d/m/Y H:i" }}
                </td>
                <td class="fw-semibold">{{ m.cochera.nombre }}</td>
                <td class="text-nowrap">{{ m.vehiculo.ticket }}</td>
                <td>{{ m.vehiculo.tipo.nombre }}</td>
                <td>
                  <span class="badge rounded-pill text-bg-{% if m.estado == 'ABIERTO' %}success{% else %}secondary{% endif %}">
                    {{ m.estado }}
                  </span>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-muted">Sin movimientos.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
